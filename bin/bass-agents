#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
AGENTS_SRC_DIR="$ROOT_DIR/agents"
AGENTS_TARGET_DIR="${HOME}/.agents"
CLI_TARGET_DIR="${HOME}/.local/bin"

usage() {
  cat <<'EOF'
Usage: bass-agents <command> [options]

Commands:
  init            First-time setup (deps + agtrace + agent links + CLI links)
  install         Link .agent files into ~/.agents and install CLI links
  review          Run review-session.py
  run             Run run-with-bass-agents.sh
  checkpoint      Run session-review-checkpoint.sh
  help            Show this help

init options:
  --skip-deps         Skip "npm install -g @lanegrid/agtrace ccusage"
  --skip-agtrace      Skip "agtrace init"
  --data-dir <path>   agtrace data dir (default: .agtrace)
  --project <path>    agtrace project root (default: .)
EOF
}

require_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: required command '$cmd' is not installed or not on PATH" >&2
    exit 1
  fi
}

link_agents() {
  if [ ! -d "$AGENTS_SRC_DIR" ]; then
    echo "Error: agents/ directory not found at $AGENTS_SRC_DIR" >&2
    exit 1
  fi

  mkdir -p "$AGENTS_TARGET_DIR"
  local count=0
  for agent_file in "$AGENTS_SRC_DIR"/*.agent; do
    [ -e "$agent_file" ] || continue
    local filename target
    filename="$(basename "$agent_file")"
    target="$AGENTS_TARGET_DIR/$filename"

    if [ -e "$target" ] && [ ! -L "$target" ]; then
      echo "skip: $target exists and is not a symlink (manual customization preserved)"
      continue
    fi

    ln -sf "$agent_file" "$target"
    echo "link: $target -> $agent_file"
    count=$((count + 1))
  done
  echo "Done. $count agent(s) linked into $AGENTS_TARGET_DIR"
}

install_cli_links() {
  mkdir -p "$CLI_TARGET_DIR"
  ln -sf "$ROOT_DIR/bin/bass-agents" "$CLI_TARGET_DIR/bass-agents"
  ln -sf "$ROOT_DIR/bin/bassai" "$CLI_TARGET_DIR/bassai"
  echo "link: $CLI_TARGET_DIR/bass-agents -> $ROOT_DIR/bin/bass-agents"
  echo "link: $CLI_TARGET_DIR/bassai -> $ROOT_DIR/bin/bassai"
  if [[ ":$PATH:" != *":$CLI_TARGET_DIR:"* ]]; then
    echo "note: add $CLI_TARGET_DIR to PATH to use 'bass-agents' and 'bassai' globally"
  fi
}

cmd_install() {
  link_agents
  install_cli_links
}

cmd_init() {
  local skip_deps="false"
  local skip_agtrace="false"
  local data_dir=".agtrace"
  local project="."

  while (($#)); do
    case "$1" in
      --skip-deps)
        skip_deps="true"
        shift
        ;;
      --skip-agtrace)
        skip_agtrace="true"
        shift
        ;;
      --data-dir)
        data_dir="${2:-}"
        if [ -z "$data_dir" ]; then
          echo "Error: --data-dir requires a value" >&2
          exit 1
        fi
        shift 2
        ;;
      --project)
        project="${2:-}"
        if [ -z "$project" ]; then
          echo "Error: --project requires a value" >&2
          exit 1
        fi
        shift 2
        ;;
      *)
        echo "Error: unknown option for init: $1" >&2
        usage
        exit 1
        ;;
    esac
  done

  cmd_install

  if [ "$skip_deps" != "true" ]; then
    require_cmd npm
    echo "Installing session-review dependencies via npm..."
    npm install -g @lanegrid/agtrace ccusage
  fi

  if [ "$skip_agtrace" != "true" ]; then
    require_cmd agtrace
    echo "Initializing agtrace in repo-local data dir ($data_dir)..."
    agtrace init --data-dir "$data_dir" --project "$project"
  fi
}

main() {
  local cmd="${1:-help}"
  case "$cmd" in
    init)
      shift
      cmd_init "$@"
      ;;
    install)
      shift
      cmd_install "$@"
      ;;
    review)
      shift
      "$ROOT_DIR/scripts/review-session.py" "$@"
      ;;
    run)
      shift
      "$ROOT_DIR/scripts/run-with-bass-agents.sh" "$@"
      ;;
    checkpoint)
      shift
      "$ROOT_DIR/scripts/session-review-checkpoint.sh" "$@"
      ;;
    help|-h|--help)
      usage
      ;;
    *)
      echo "Error: unknown command '$cmd'" >&2
      usage
      exit 1
      ;;
  esac
}

main "$@"
