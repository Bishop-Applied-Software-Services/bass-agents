#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
AGENTS_SRC_DIR="$ROOT_DIR/agents"
AGENTS_TARGET_DIR="${HOME}/.agents"
CLI_TARGET_DIR="${HOME}/.local/bin"

usage() {
  cat <<'EOF'
Usage: bass-agents <command> [options]

Commands:
  init            First-time setup (deps + agtrace + agent links + CLI links)
  install         Link .agent files into ~/.agents and install CLI links
  memory          Run memory management commands
  dashboards      Unified dashboard launcher (session + workspace, web + tui)
  review          Run review-session.py
  run             Run run-with-bass-agents.sh
  checkpoint      Run session-review-checkpoint.sh
  dashboard       Build session-review dashboard (web by default, --tui for terminal)
  help            Show this help

init options:
  --skip-deps         Skip "npm install -g @lanegrid/agtrace ccusage"
  --skip-agtrace      Skip "agtrace init"
  --data-dir <path>   agtrace data dir (default: .agtrace)
  --project <path>    agtrace project root (default: .)

dashboards options:
  --web               Build web dashboards (default mode)
  --tui               Launch a TUI dashboard
  --session           Include session-review dashboard
  --memory            Include workspace dashboard (tickets + durable memory in web mode)
  --all               Memory scope: all projects (default)
  --project <name>    Memory scope: single project
Examples:
  bass-agents dashboards
  bass-agents dashboards --web --session --memory --project bass-agents
  bass-agents dashboards --tui --session
  bass-agents dashboards --tui --memory --project bass-agents
EOF
}

require_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: required command '$cmd' is not installed or not on PATH" >&2
    exit 1
  fi
}

link_agents() {
  if [ ! -d "$AGENTS_SRC_DIR" ]; then
    echo "Error: agents/ directory not found at $AGENTS_SRC_DIR" >&2
    exit 1
  fi

  mkdir -p "$AGENTS_TARGET_DIR"
  local count=0
  for agent_file in "$AGENTS_SRC_DIR"/*.agent; do
    [ -e "$agent_file" ] || continue
    local filename target
    filename="$(basename "$agent_file")"
    target="$AGENTS_TARGET_DIR/$filename"

    if [ -e "$target" ] && [ ! -L "$target" ]; then
      echo "skip: $target exists and is not a symlink (manual customization preserved)"
      continue
    fi

    ln -sf "$agent_file" "$target"
    echo "link: $target -> $agent_file"
    count=$((count + 1))
  done
  echo "Done. $count agent(s) linked into $AGENTS_TARGET_DIR"
}

install_cli_links() {
  mkdir -p "$CLI_TARGET_DIR"
  ln -sf "$ROOT_DIR/bin/bass-agents" "$CLI_TARGET_DIR/bass-agents"
  ln -sf "$ROOT_DIR/bin/bassai" "$CLI_TARGET_DIR/bassai"
  echo "link: $CLI_TARGET_DIR/bass-agents -> $ROOT_DIR/bin/bass-agents"
  echo "link: $CLI_TARGET_DIR/bassai -> $ROOT_DIR/bin/bassai"
  if [[ ":$PATH:" != *":$CLI_TARGET_DIR:"* ]]; then
    echo "note: add $CLI_TARGET_DIR to PATH to use 'bass-agents' and 'bassai' globally"
  fi
}

cmd_install() {
  link_agents
  install_cli_links
}

cmd_init() {
  local skip_deps="false"
  local skip_agtrace="false"
  local data_dir=".agtrace"
  local project="."

  while (($#)); do
    case "$1" in
      --skip-deps)
        skip_deps="true"
        shift
        ;;
      --skip-agtrace)
        skip_agtrace="true"
        shift
        ;;
      --data-dir)
        data_dir="${2:-}"
        if [ -z "$data_dir" ]; then
          echo "Error: --data-dir requires a value" >&2
          exit 1
        fi
        shift 2
        ;;
      --project)
        project="${2:-}"
        if [ -z "$project" ]; then
          echo "Error: --project requires a value" >&2
          exit 1
        fi
        shift 2
        ;;
      *)
        echo "Error: unknown option for init: $1" >&2
        usage
        exit 1
        ;;
    esac
  done

  cmd_install

  if [ "$skip_deps" != "true" ]; then
    require_cmd npm
    echo "Installing session-review dependencies via npm..."
    npm install -g @lanegrid/agtrace ccusage
  fi

  if [ "$skip_agtrace" != "true" ]; then
    require_cmd agtrace
    echo "Initializing agtrace in repo-local data dir ($data_dir)..."
    agtrace init --data-dir "$data_dir" --project "$project"
  fi
}

main() {
  local cmd="${1:-help}"
  case "$cmd" in
    init)
      shift
      cmd_init "$@"
      ;;
    install)
      shift
      cmd_install "$@"
      ;;
    review)
      shift
      "$ROOT_DIR/scripts/review-session.py" "$@"
      ;;
    memory)
      shift
      if [ -f "$ROOT_DIR/src/cli/memory-commands.ts" ]; then
        npx ts-node "$ROOT_DIR/src/cli/memory-commands.ts" "$@"
      elif [ -f "$ROOT_DIR/dist/cli/memory-commands.js" ]; then
        node "$ROOT_DIR/dist/cli/memory-commands.js" "$@"
      else
        echo "Error: memory CLI not found (expected src/cli/memory-commands.ts or dist/cli/memory-commands.js)" >&2
        exit 1
      fi
      ;;
    dashboards)
      shift
      mode="web"
      include_session="false"
      include_memory="false"
      memory_all="true"
      memory_project=""

      while (($#)); do
        case "$1" in
          --web)
            mode="web"
            shift
            ;;
          --tui)
            mode="tui"
            shift
            ;;
          --session)
            include_session="true"
            shift
            ;;
          --memory)
            include_memory="true"
            shift
            ;;
          --all)
            memory_all="true"
            memory_project=""
            shift
            ;;
          --project)
            memory_project="${2:-}"
            if [ -z "$memory_project" ]; then
              echo "Error: --project requires a value" >&2
              exit 1
            fi
            memory_all="false"
            shift 2
            ;;
          -h|--help)
            usage
            exit 0
            ;;
          *)
            echo "Error: unknown dashboards option '$1'" >&2
            exit 1
            ;;
        esac
      done

      # Default to both scopes if neither specified.
      if [ "$include_session" = "false" ] && [ "$include_memory" = "false" ]; then
        include_session="true"
        include_memory="true"
      fi

      if [ "$mode" = "web" ]; then
        if [ "$include_session" = "true" ]; then
          "$ROOT_DIR/scripts/session-review-dashboard.py"
          echo "Session review web: $ROOT_DIR/session-reviews/dashboard.html"
        fi
        if [ "$include_memory" = "true" ]; then
          if [ "$memory_all" = "true" ]; then
            "$0" memory dashboard --all --web --out ai-memory/dashboard.html
            echo "Workspace web (all memory projects): $ROOT_DIR/ai-memory/dashboard.html"
          else
            "$0" memory dashboard "$memory_project" --web
            echo "Workspace web ($memory_project): $ROOT_DIR/ai-memory/${memory_project}-dashboard.html"
          fi
        fi
      else
        # TUI mode launches one dashboard process at a time.
        if [ "$include_session" = "true" ] && [ "$include_memory" = "true" ]; then
          echo "TUI mode supports one dashboard at a time. Launching session-review TUI first."
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py"
          if [ "$memory_all" = "true" ]; then
            "$0" memory dashboard --all
          else
            "$0" memory dashboard "$memory_project"
          fi
        elif [ "$include_session" = "true" ]; then
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py"
        elif [ "$include_memory" = "true" ]; then
          if [ "$memory_all" = "true" ]; then
            "$0" memory dashboard --all
          else
            "$0" memory dashboard "$memory_project"
          fi
        fi
      fi
      ;;
    run)
      shift
      "$ROOT_DIR/scripts/run-with-bass-agents.sh" "$@"
      ;;
    checkpoint)
      shift
      "$ROOT_DIR/scripts/session-review-checkpoint.sh" "$@"
      ;;
    dashboard)
      shift
      dashboard_mode="web"
      filtered_args=()
      for arg in "$@"; do
        if [ "$arg" = "--tui" ]; then
          dashboard_mode="tui"
          continue
        fi
        filtered_args+=("$arg")
      done
      if [ "$dashboard_mode" = "tui" ]; then
        if [ ${#filtered_args[@]} -gt 0 ]; then
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py" "${filtered_args[@]}"
        else
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py"
        fi
      else
        if [ ${#filtered_args[@]} -gt 0 ]; then
          "$ROOT_DIR/scripts/session-review-dashboard.py" "${filtered_args[@]}"
        else
          "$ROOT_DIR/scripts/session-review-dashboard.py"
        fi
      fi
      ;;
    help|-h|--help)
      usage
      ;;
    *)
      echo "Error: unknown command '$cmd'" >&2
      usage
      exit 1
      ;;
  esac
}

main "$@"
