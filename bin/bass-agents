#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
AGENTS_SRC_DIR="$ROOT_DIR/agents"
AGENTS_TARGET_DIR="${HOME}/.agents"
CLI_TARGET_DIR="${HOME}/.local/bin"

usage() {
  cat <<'EOF'
Usage: bass-agents <command> [options]

Commands:
  init            Initialize bass-agents state for the current project
  install         Link .agent files into ~/.agents and install CLI links
  install-custom-agents Install generated Claude/Codex agent bundles into target config dirs
  memory          Run memory management commands
  dashboards      Unified dashboard launcher for the current project
  review          Run review-session.py
  run             Run run-with-bass-agents.sh
  checkpoint      Run session-review-checkpoint.sh
  dashboard       Build session-review dashboard (web by default, --tui for terminal)
  help            Show this help

init options:
  --project <path>    Project root to initialize (default: .)
  --durable-memory    Enable project-local durable memory
  --no-durable-memory Disable project-local durable memory
  --install-custom-agents  Install generated custom agents without prompting
  --no-install-custom-agents Skip custom-agent installation without prompting
  --custom-agents-tool <all|claude|codex> Install target tool (default: all)
  --custom-agents-scope <project|user> Install scope (default: project)
  --agtrace           Initialize local .agtrace state

Init also exports project-local Claude and Codex agent bundles under .bass-agents/custom-agents/.

install-custom-agents options:
  --project <path>          Source project root with generated bundles (default: .)
  --scope <project|user>    Install into project-local or user-local config roots (default: project)
  --tool <all|claude|codex> Install Claude bundles, Codex bundles, or both (default: all)

dashboards options:
  --web               Build web dashboards (default mode)
  --tui               Launch a TUI dashboard
  --session           Include session-review dashboard
  --memory            Include durable-memory dashboard
  --project <path>    Project root (default: .)
Examples:
  bass-agents dashboards
  bass-agents dashboards --web --session --memory --project ../my-project
  bass-agents dashboards --tui --session
  bass-agents dashboards --tui --memory
EOF
}

require_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: required command '$cmd' is not installed or not on PATH" >&2
    exit 1
  fi
}

link_agents() {
  if [ ! -d "$AGENTS_SRC_DIR" ]; then
    echo "Error: agents/ directory not found at $AGENTS_SRC_DIR" >&2
    exit 1
  fi

  mkdir -p "$AGENTS_TARGET_DIR"
  local count=0
  for agent_file in "$AGENTS_SRC_DIR"/*.agent; do
    [ -e "$agent_file" ] || continue
    local filename target
    filename="$(basename "$agent_file")"
    target="$AGENTS_TARGET_DIR/$filename"

    if [ -e "$target" ] && [ ! -L "$target" ]; then
      echo "skip: $target exists and is not a symlink (manual customization preserved)"
      continue
    fi

    ln -sf "$agent_file" "$target"
    echo "link: $target -> $agent_file"
    count=$((count + 1))
  done
  echo "Done. $count agent(s) linked into $AGENTS_TARGET_DIR"
}

install_cli_links() {
  mkdir -p "$CLI_TARGET_DIR"
  ln -sf "$ROOT_DIR/bin/bass-agents" "$CLI_TARGET_DIR/bass-agents"
  ln -sf "$ROOT_DIR/bin/bassai" "$CLI_TARGET_DIR/bassai"
  echo "link: $CLI_TARGET_DIR/bass-agents -> $ROOT_DIR/bin/bass-agents"
  echo "link: $CLI_TARGET_DIR/bassai -> $ROOT_DIR/bin/bassai"
  if [[ ":$PATH:" != *":$CLI_TARGET_DIR:"* ]]; then
    echo "note: add $CLI_TARGET_DIR to PATH to use 'bass-agents' and 'bassai' globally"
  fi
}

cmd_install() {
  link_agents
  install_cli_links
}

cmd_init() {
  if [ -f "$ROOT_DIR/src/cli/init-command.ts" ]; then
    npx ts-node "$ROOT_DIR/src/cli/init-command.ts" "$@"
  elif [ -f "$ROOT_DIR/dist/cli/init-command.js" ]; then
    node "$ROOT_DIR/dist/cli/init-command.js" "$@"
  else
    echo "Error: init CLI not found (expected src/cli/init-command.ts or dist/cli/init-command.js)" >&2
    exit 1
  fi
}

cmd_install_custom_agents() {
  if [ -f "$ROOT_DIR/src/cli/install-custom-agents-command.ts" ]; then
    npx ts-node "$ROOT_DIR/src/cli/install-custom-agents-command.ts" "$@"
  elif [ -f "$ROOT_DIR/dist/cli/install-custom-agents-command.js" ]; then
    node "$ROOT_DIR/dist/cli/install-custom-agents-command.js" "$@"
  else
    echo "Error: install-custom-agents CLI not found (expected src/cli/install-custom-agents-command.ts or dist/cli/install-custom-agents-command.js)" >&2
    exit 1
  fi
}

main() {
  local cmd="${1:-help}"
  case "$cmd" in
    init)
      shift
      cmd_init "$@"
      ;;
    install)
      shift
      cmd_install "$@"
      ;;
    install-custom-agents)
      shift
      cmd_install_custom_agents "$@"
      ;;
    review)
      shift
      "$ROOT_DIR/scripts/review-session.py" "$@"
      ;;
    memory)
      shift
      if [ -f "$ROOT_DIR/src/cli/memory-commands.ts" ]; then
        npx ts-node "$ROOT_DIR/src/cli/memory-commands.ts" "$@"
      elif [ -f "$ROOT_DIR/dist/cli/memory-commands.js" ]; then
        node "$ROOT_DIR/dist/cli/memory-commands.js" "$@"
      else
        echo "Error: memory CLI not found (expected src/cli/memory-commands.ts or dist/cli/memory-commands.js)" >&2
        exit 1
      fi
      ;;
    dashboards)
      shift
      local mode="web"
      local include_session="false"
      local include_memory="false"
      local project_root="."
      local dashboards_root=""
      local session_out=""
      local memory_out=""

      while (($#)); do
        case "$1" in
          --web)
            mode="web"
            shift
            ;;
          --tui)
            mode="tui"
            shift
            ;;
          --session)
            include_session="true"
            shift
            ;;
          --memory)
            include_memory="true"
            shift
            ;;
          --project)
            project_root="${2:-}"
            if [ -z "$project_root" ]; then
              echo "Error: --project requires a value" >&2
              exit 1
            fi
            shift 2
            ;;
          -h|--help)
            usage
            exit 0
            ;;
          *)
            echo "Error: unknown dashboards option '$1'" >&2
            exit 1
            ;;
        esac
      done

      # Default to both scopes if neither specified.
      if [ "$include_session" = "false" ] && [ "$include_memory" = "false" ]; then
        include_session="true"
        include_memory="true"
      fi

      project_root="$(cd "$project_root" && pwd)"
      dashboards_root="$project_root/.bass-agents/dashboards"
      session_out="$dashboards_root/session-reviews.html"
      memory_out="$dashboards_root/memory-dashboard.html"
      mkdir -p "$dashboards_root"

      if [ "$mode" = "web" ]; then
        if [ "$include_session" = "true" ]; then
          "$ROOT_DIR/scripts/session-review-dashboard.py" \
            --root "$project_root/session-reviews" \
            --out "$session_out"
          echo "Session review web: $session_out"
        fi
        if [ "$include_memory" = "true" ]; then
          "$0" memory dashboard --project "$project_root" --web --out "$memory_out"
          echo "Durable memory web: $memory_out"
        fi
      else
        if [ "$include_session" = "true" ] && [ "$include_memory" = "true" ]; then
          echo "TUI mode supports one dashboard at a time. Launching session-review TUI first."
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py" --root "$project_root/session-reviews"
          "$0" memory dashboard --project "$project_root"
        elif [ "$include_session" = "true" ]; then
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py" --root "$project_root/session-reviews"
        elif [ "$include_memory" = "true" ]; then
          "$0" memory dashboard --project "$project_root"
        fi
      fi
      ;;
    run)
      shift
      "$ROOT_DIR/scripts/run-with-bass-agents.sh" "$@"
      ;;
    checkpoint)
      shift
      "$ROOT_DIR/scripts/session-review-checkpoint.sh" "$@"
      ;;
    dashboard)
      shift
      dashboard_mode="web"
      filtered_args=()
      for arg in "$@"; do
        if [ "$arg" = "--tui" ]; then
          dashboard_mode="tui"
          continue
        fi
        filtered_args+=("$arg")
      done
      if [ "$dashboard_mode" = "tui" ]; then
        if [ ${#filtered_args[@]} -gt 0 ]; then
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py" "${filtered_args[@]}"
        else
          "$ROOT_DIR/scripts/session-review-dashboard-tui.py"
        fi
      else
        if [ ${#filtered_args[@]} -gt 0 ]; then
          "$ROOT_DIR/scripts/session-review-dashboard.py" "${filtered_args[@]}"
        else
          "$ROOT_DIR/scripts/session-review-dashboard.py"
        fi
      fi
      ;;
    help|-h|--help)
      usage
      ;;
    *)
      echo "Error: unknown command '$cmd'" >&2
      usage
      exit 1
      ;;
  esac
}

main "$@"
